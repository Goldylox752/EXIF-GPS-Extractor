// Helper: Convert EXIF Rational (two 32-bit ints) to a float
const getRational = (view, offset, endian) => {
    const num = view.getUint32(offset, endian);
    const den = view.getUint32(offset + 4, endian);
    return num / den;
};

// Main parsing logic inside your loop
// ... (inside the IFD loop from the previous step)

if (tag === 0x8825) { // 0x8825 is the pointer to the GPS IFD
    const gpsIFDOffset = view.getUint32(entryOffset + 8, littleEndian);
    const gpsStart = tiffStart + gpsIFDOffset;
    const gpsEntries = view.getUint16(gpsStart, littleEndian);

    let lat, latRef, lon, lonRef;

    for (let j = 0; j < gpsEntries; j++) {
        const subEntryOffset = gpsStart + 2 + (j * 12);
        const subTag = view.getUint16(subEntryOffset, littleEndian);
        const valOffset = view.getUint32(subEntryOffset + 8, littleEndian);
        const absoluteOffset = tiffStart + valOffset;

        if (subTag === 1) latRef = getString(view, subEntryOffset + 8, 1); // 'N' or 'S'
        if (subTag === 2) { // Latitude (Degrees, Minutes, Seconds)
            const d = getRational(view, absoluteOffset, littleEndian);
            const m = getRational(view, absoluteOffset + 8, littleEndian);
            const s = getRational(view, absoluteOffset + 16, littleEndian);
            lat = d + (m / 60) + (s / 3600);
        }
        if (subTag === 3) lonRef = getString(view, subEntryOffset + 8, 1); // 'E' or 'W'
        if (subTag === 4) { // Longitude
            const d = getRational(view, absoluteOffset, littleEndian);
            const m = getRational(view, absoluteOffset + 8, littleEndian);
            const s = getRational(view, absoluteOffset + 16, littleEndian);
            lon = d + (m / 60) + (s / 3600);
        }
    }

    if (lat && lon) {
        const finalLat = latRef === 'S' ? -lat : lat;
        const finalLon = lonRef === 'W' ? -lon : lon;
        output.innerText += `ðŸ“ Location: ${finalLat.toFixed(6)}, ${finalLon.toFixed(6)}\n`;
        output.innerText += `ðŸ”— Google Maps: https://www.google.com/maps?q=${finalLat},${finalLon}\n`;
    }
}
